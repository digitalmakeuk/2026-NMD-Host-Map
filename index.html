<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Participation Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root { --sidebar-w: 390px; }
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

.app { display:flex; height:100vh; width:100vw; }

.sidebar {
  width: var(--sidebar-w);
  min-width: 280px;
  border-right: 1px solid #e6e6e6;
  background:#fff;
  display:flex;
  flex-direction:column;
}

.topbar { padding:14px; border-bottom:1px solid #eee; }
.title { font-weight:800; margin-bottom:10px; font-size:15px; }

.controls input {
  width:100%;
  padding:10px;
  border:1px solid #ddd;
  border-radius:10px;
  font-size:14px;
}

.list { overflow:auto; padding:12px; }

.item {
  display:flex;
  gap:10px;
  padding:12px;
  border:1px solid #eee;
  border-radius:12px;
  margin-bottom:10px;
  cursor:pointer;
}

.logo {
  width:44px;
  height:44px;
  border-radius:10px;
  object-fit:cover;
  border:1px solid #eee;
  background:#fafafa;
}

.name { font-weight:700; font-size:14px; }
.sub { font-size:12px; color:#666; margin-top:6px; }

.map { flex:1; }
#map { height:100%; width:100%; }

.details { overflow:auto; padding:12px; display:none; }
.details.active { display:block; }

.backbtn{
  border:1px solid #ddd;
  padding:8px 10px;
  border-radius:10px;
  background:#fff;
  cursor:pointer;
  margin-bottom:10px;
}

.details img {
  width:100%;
  max-height:180px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #eee;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <div class="topbar">
      <div class="title">Participation Map</div>
      <input id="search" type="search" placeholder="Type county or postcode prefix…" />
    </div>

    <div id="list" class="list"></div>
    <div id="details" class="details"></div>
  </aside>

  <main class="map">
    <div id="map"></div>
  </main>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const GEOJSON_ENDPOINT = "https://script.google.com/macros/s/AKfycbzvn-aL9-198YzDTCGl10sj2brAcoGRR7EYk5IoArX90CroRBUhO8qppLFqcWhUU4rz/exec";

const map = L.map("map").setView([54.5, -3.0], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

let allFeatures = [];
let geoLayer = null;
let markerById = new Map();
let prevView = null;

const listEl = document.getElementById("list");
const detailsEl = document.getElementById("details");

function esc(s) {
  return String(s || "").replace(/[&<>"']/g, c => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#039;"
  }[c]));
}

function cleanUrl(u) {
  const s = String(u || "").trim();
  if (!s) return "";
  return s.startsWith("http") ? s : "https://" + s;
}

function norm(s){ return String(s || "").toLowerCase().trim(); }
function normPostcode(s){ return norm(s).replace(/\s+/g,""); }

function popupHtml(p){
  const img = p.image_url ? `<img src="${esc(p.image_url)}" style="max-width:240px;max-height:160px;object-fit:cover;border-radius:10px;border:1px solid #eee;margin:8px 0;">` : "";
  const address = [p.address, p.suite].filter(Boolean).join(", ");
  const website = p.website ? `<div><a href="${esc(cleanUrl(p.website))}" target="_blank">Visit website</a></div>` : "";

  return `
    <div style="min-width:220px;">
      <div style="font-weight:700;">${esc(p.name)}</div>
      ${img}
      ${address ? `<div style="font-size:12px;color:#666;">${esc(address)}</div>` : ""}
      ${website}
    </div>
  `;
}

function showList(){
  detailsEl.classList.remove("active");
  listEl.style.display = "";
  if(prevView){
    map.flyTo(prevView.center, prevView.zoom, {duration:0.6});
  }
}

function showDetails(feature){
  const p = feature.properties;
  const address = [p.address, p.suite].filter(Boolean).join(", ");

  listEl.style.display = "none";
  detailsEl.classList.add("active");

  detailsEl.innerHTML = `
    <button class="backbtn">← Back</button>
    <h2>${esc(p.name)}</h2>
    ${p.image_url ? `<img src="${esc(p.image_url)}">` : ""}
    ${address ? `<div><b>Address:</b> ${esc(address)}</div>` : ""}
    ${p.county ? `<div><b>County:</b> ${esc(p.county)}</div>` : ""}
    ${p.postcode ? `<div><b>Postcode:</b> ${esc(p.postcode)}</div>` : ""}
    ${p.telephone ? `<div><b>Telephone:</b> ${esc(p.telephone)}</div>` : ""}
    ${p.website ? `<div><b>Website:</b> <a href="${esc(cleanUrl(p.website))}" target="_blank">${esc(p.website)}</a></div>` : ""}
    ${p.description ? `<div><b>Description:</b>
${esc(p.description)}</div>` : ""}
  `;

  detailsEl.querySelector(".backbtn").onclick = showList;
}

function selectFeature(f){
  prevView = { center: map.getCenter(), zoom: map.getZoom() };
  const marker = markerById.get(f.__id);
  if(marker){
    map.flyTo(marker.getLatLng(), 14, {duration:0.6});
    setTimeout(()=>marker.openPopup(),250);
  }
  showDetails(f);
}

function render(features){
  if(geoLayer) map.removeLayer(geoLayer);
  markerById.clear();

  geoLayer = L.geoJSON({type:"FeatureCollection", features}, {
    pointToLayer: (f,latlng)=>{
      const m = L.marker(latlng);
      m.bindPopup(popupHtml(f.properties));
      m.on("click", ()=>selectFeature(f));
      return m;
    },
    onEachFeature:(f,layer)=>markerById.set(f.__id,layer)
  }).addTo(map);

  if(features.length){
    map.fitBounds(geoLayer.getBounds().pad(0.12));
  }

  renderList(features);
}

function renderList(features){
  listEl.innerHTML = "";

  if(!features.length){
    listEl.innerHTML = "<div>No matches.</div>";
    return;
  }

  features.forEach(f=>{
    const p = f.properties;
    const address = [p.address, p.suite].filter(Boolean).join(", ");

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      ${p.image_url ? `<img class="logo" src="${esc(p.image_url)}">` : ""}
      <div>
        <div class="name">${esc(p.name)}</div>
        ${address ? `<div class="sub">${esc(address)}</div>` : ""}
        ${p.county ? `<div class="sub">${esc(p.county)}</div>` : ""}
        ${p.postcode ? `<div class="sub">${esc(p.postcode)}</div>` : ""}
      </div>
    `;
    div.onclick = ()=>selectFeature(f);
    listEl.appendChild(div);
  });
}

function applyFilters(){
  const qRaw = norm(document.getElementById("search").value);
  const qPc = normPostcode(qRaw);
  const isPostcode = /\d/.test(qRaw);

  const filtered = allFeatures.filter(f=>{
    if(!qRaw) return true;
    const county = norm(f.properties.county);
    const postcode = normPostcode(f.properties.postcode);
    return isPostcode ? postcode.startsWith(qPc) : county.startsWith(qRaw);
  });

  render(filtered);
}

async function init(){
  const res = await fetch(GEOJSON_ENDPOINT,{cache:"no-store"});
  const data = await res.json();

  allFeatures = (data.features||[]).map((f,i)=>{
    f.__id = (f.properties.name||"item")+"-"+i;
    return f;
  });

  applyFilters();
}

document.getElementById("search").addEventListener("input", ()=>{
  showList();
  applyFilters();
});

init();
</script>
</body>
</html>